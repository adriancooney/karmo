/**
 * Karmo - Gamble away your reddit karma
 *
 * Rules of the game:
 * 	You bet on posts to reach a certain amount of karma
 */var Karmo={DEBUG:!0,URL:"http://localhost:8181",log:function(){Karmo.DEBUG&&console.log.apply(console,arguments)},error:function(){if(Karmo.DEBUG)throw Error.apply(Error,arguments)},template:{url:"templates/",extension:".template",templateNames:["small-bet-view","large-bet-view","main-bet-view","bet-list","notification","dashboard"],templates:{},getTemplates:function(e){(function t(n){Karmo.model.ajax({url:chrome.runtime.getURL(Karmo.template.url+n[0]+Karmo.template.extension),responseType:"text"},function(r){Karmo.template.templates[n[0]]=r;n.shift();n[0]?t(n):e()})})(Karmo.template.templateNames)},render:function(e,t,n,r){var r=Mustache.render(Karmo.template.templates[n],r);switch(t){case"prepend":e.innerHTML=r+e.innerHTML;break;case"replace":e.innerHTML=r;break;case"append":default:e.innerHTML=e.innerHTML+r}}},sound:{sounds:["chaching"],init:function(){Karmo.sound.sounds.forEach(function(e){var t=document.createElement("audio");document.body.appendChild(t);t.id="karmo-sound-"+e;t.volume=0;t.autoplay=!0;t.src=chrome.runtime.getURL("assets/audio/"+e+".mp3")})},play:function(e){var t=document.getElementById("karmo-sound-"+e);t.volume=1;t.play()}},storage:{prefix:"karmo.",get:function(e){var t=window.localStorage.getItem(Karmo.storage.prefix+e),n=/^(\w+);/.exec(t);if(!n)return t;t=t.replace(n[1]+";","");switch(n[1]){case"json":return JSON.parse(t);default:return t}},save:function(e,t){typeof t=="object"&&(t="json;"+JSON.stringify(t));return window.localStorage.setItem(Karmo.storage.prefix+e,t)}},model:{ajax:function(e,t,n,r){e.url||Karmo.error("Karmo.model.ajax: Please provide a url in the options object.");t||Karmo.error("Karmo.model.ajax: Please provide a callback as a second parameter.");var i=Karmo.storage.get(e.url);if(!r&&i&&!Karmo.DEBUG){Karmo.log("Loading from cache: ",e.url);t(i,this)}else{var s={method:"get",responseType:"json"};for(var o in s)e[o]||(e[o]=s[o]);var u=new XMLHttpRequest;u.open(e.method.toUpperCase(),e.url,!0);u.onreadystatechange=function(){if(this.readyState==4)if(this.status==200){data=this.response;switch(e.responseType){case"json":data=JSON.parse(data)}Karmo.storage.save(e.url,data);t(data,this)}else n&&n(this)};u.send()}},betting:{getBettingDataOnPost:function(e,t){return{bets:15,odds:{top:1,bottom:10},status:{"class":"hot",text:"Hot!"}}},yourBets:function(e,t){var n=Karmo.model.current.username,r=function(e){t(e.data.bets)};switch(e){case"all":Karmo.model.ajax({url:Karmo.URL+"/bets/user/"+n,responseType:"json"},r);break;case"won":case"lost":case"pending":Karmo.model.ajax({url:Karmo.URL+"/bets/user/"+n+"/"+e,responseType:"json"},r)}},calculateOddsOnPost:function(e,t,n){},checkBets:function(){Karmo.model.betting.yourBets("pending",function(e){e.forEach(function(e){var t=new Date,n=Date.parse(e.deadline);n-t<=0&&Karmo.model.betting.updateBet(e.id)})})},updateBet:function(e,t){Karmo.model.ajax({url:Karmo.URL+"/bet/"+e+"/update",responseType:"json"},function(e){})},create:function(){}},user:{getUser:function(e){e({username:"renegademaniac",karma:1800,karmo:12e3,bets:200})},isUserAPlayer:function(e,t){t(!0)}},current:{subreddit:function(){return document.querySelectorAll(".pagename")[0].innerText}(),username:function(){return document.querySelectorAll(".user a")[0].innerText}()}},view:{betting:{displayBetSmall:function(e,t){Karmo.template.render(e,"prepend","small-bet-view",t);e.querySelectorAll(".bet")[0].addEventListener("click",function(){Karmo.view.betting.displayBetLarge(e,t)})},displayBetLarge:function(e,t){var n=e.querySelectorAll(".karmo-large-bet-view");Karmo.template.render(e,"append","large-bet-view",t)},hideLargeBetDisplay:function(e){}},user:{displayKarmoSmall:function(e){var t=document.querySelectorAll(".userkarma")[0];t.innerHTML=e.karma+"/"+e.karmo+"";t.setAttribute("alt","Your karma and karmo")},displayKarmoLarge:function(e){var t=document.querySelectorAll(".titlebox")[0],n='<span class="karma karmo">'+e.karmo+"</span> karmo",r=t.innerHTML.replace("<br>","<br>"+n+"<br>");t.innerHTML=r},displayIsUsersPlayers:function(e){Karmo.model.user.isUserAPlayer(e.innerText,function(t){if(t){var n=document.createElement("a");n.setAttribute("alt","This redditor plays Karmo.");n.classList.add("karmo-dot");e.parentNode.insertBefore(n,e.nextSibling);n.addEventListener("mouseover",function(){Karmo.view.user.displayDotInformationPopup(n)})}})},displayDotInformationPopup:function(e){}},bets:{init:function(){var e=document.querySelectorAll("div.content")[0];Karmo.template.render(e,"replace","main-bet-view");Karmo.view.bets.loadBetList("you","all");setTimeout(function(){var e=document.querySelectorAll(".karmo-list-options a");Array.prototype.forEach.call(e,function(e){e.addEventListener("click",function(){var e=this.id.split("-"),t=e[0],n=e[1];Karmo.view.bets.loadBetList(t,n);this.parentNode.querySelectorAll(".highlighted")[0].classList.remove("highlighted");this.classList.add("highlighted")})})},50)},list:function(e){var t=document.querySelectorAll(".karmo-main-bet-view")[0];Karmo.log("Listing bets",t);Karmo.template.render(t,"replace","bet-list",{bets:e,bets_empty:function(){if(!e.length>0)return!0},deadlinePretty:function(){return moment(this.deadline).fromNow()},status:function(){return!this.active&&this.won?"Won":!this.active&&!this.won?"Lost":"Pending"},betType:function(){if(this.type=="karma")return"Karma";if(this.type=="comment-count")return"Comment Count"}})},loading:function(e){var t=document.getElementById("karmo-loading");Karmo.log("Hiding loading..",e);t&&(e?t.classList.add("active"):t.classList.remove("active"))},loadBetList:function(e,t){function n(e){console.log("Called!",arguments.callee);Karmo.view.bets.loading(!1);Karmo.view.bets.list(e)}Karmo.view.bets.loading(!0);e=="you"?Karmo.model.betting.yourBets(t,n):e=="everyone"&&Karmo.model.betting.everyonesBets(t,n)}},dashboard:{init:function(){}},displayKarmoOnListView:function(){Karmo.view.loopOverPosts(function(e){var t=Karmo.model.betting.getBettingDataOnPost();Karmo.view.betting.displayBetSmall(e,t)})},loopOverPosts:function(e){var t=document.querySelectorAll("#siteTable .thing");t&&Array.prototype.forEach.call(t,e)},modal:{create:function(e,t,n,r){var i=document.createElement("div");o.classList.add("karmo-modal-lightbox");var s=document.createElement("div");o.classList.add("karmo-modal-wrapper");var o=document.createElement("div");o.classList.add("modal");o.style.marginTop=t/2+"px";o.style.marginLeft=e/2+"px";o.style.width=e+"px";o.style.height=t+"px";Karmo.template.render(o,"append",n,r)}},notification:{won:function(){Karmo.view.notification.create("Cha-ching!","You just won 14000 karmo.",5e3,function(){})},create:function(e,t,n,r){function i(){var e=document.getElementById("karmo-notification");if(e){e.style.opacity=0;e.style.webkitTransform="translate(0, -30px)";setTimeout(function(){e.parentNode.removeChild(e)},100)}}Karmo.template.render(document.body,"prepend","notification",{title:e,message:t});r&&setTimeout(function(){var e=document.getElementById("karmo-notification");e.style.opacity=1;e.style.webkitTransform="translate(0,0)";e.addEventListener("click",function(){i();r()})},50);setTimeout(i,n)}}},routes:{".*":function(){Karmo.model.user.getUser(function(e){Karmo.view.user.displayKarmoSmall(e)});(function e(){Karmo.model.betting.checkBets();setTimeout(e,5e3)})()},"/me/karmo":function(){Karmo.log("Main Page!");document.querySelectorAll(".pagename")[0].innerText="Karmo";var e=document.querySelectorAll("div.content")[0];e.innerHTML="";Karmo.template.render(e,"append","dashboard")},"\\/r\\/\\w+(?:/(top|controversial|rising|new)|(?!comments))?":function(e){Karmo.log("Sub reddit route matched.");Karmo.view.displayKarmoOnListView();var t=document.createElement("li"),n=document.createElement("a");n.setAttribute("href","#bets");n.innerText="bets";t.appendChild(n);document.querySelectorAll(".tabmenu")[0].appendChild(t);n.addEventListener("click",function(){var e=document.querySelectorAll(".tabmenu .selected")[0];e.classList.remove("selected");t.classList.add("selected");Karmo.view.bets.init()})},"\\/user\\/([^\\/]+)":function(){Karmo.log("User view matched");Karmo.model.user.getUser(function(e){Karmo.view.user.displayKarmoLarge(e)})}},init:function(){Karmo.log("Route: ",window.location.pathname);Karmo.template.getTemplates(function(){for(var e in Karmo.routes){var t=(new RegExp(e)).exec(window.location.pathname);t&&Karmo.routes[e].call(Karmo,t)}})}};Karmo.init();